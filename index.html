<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ëˆ—ì…ˆ í•™ìŠµ ì„¼í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* Common Styles */
        .division-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: 0 10px;
            font-size: 1.5rem;
            line-height: 2rem;
            width: fit-content;
        }
        .font-mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        .divisor {
            grid-row: 2;
            padding-right: 10px;
            border-right: 2px solid #333;
        }
        .dividend {
            grid-row: 2;
            grid-column: 2;
            letter-spacing: 0.5em;
            padding-left: 0.5em;
        }
        .quotient {
            grid-row: 1;
            grid-column: 2;
            letter-spacing: 0.5em;
            padding-left: 0.5em;
            border-bottom: 2px solid #333;
            height: 2rem;
        }
        .calc-step {
            grid-column: 2;
            letter-spacing: 0.5em;
            padding-left: 0.5em;
        }
        .highlight { color: #EF4444; font-weight: 700; }
        .highlight-blue { color: #3B82F6; font-weight: 700; }
        .highlight-green { color: #22C55E; font-weight: 700; }
        .step-line { border-bottom: 2px solid #333; }
        .hundred-bar { fill: #FCA5A5; transition: all 0.5s ease; }
        .ten-bar { fill: #93C5FD; transition: all 0.5s ease; }
        .one-bar { fill: #A7F3D0; transition: all 0.5s ease; }
        .group-box { stroke: #F87171; stroke-width: 2; fill: none; stroke-dasharray: 4 2; }
        .exchange-highlight {
            filter: drop-shadow(0 0 6px #FBBF24);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        /* Learning Page Specific */
        #learning-section .timeline-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 100%;
            padding-left: 1rem;
        }
        #learning-section .timeline-line {
            width: 2px;
            background-color: #CBD5E1;
            flex-grow: 1;
            margin: -2px 0;
        }
        #learning-section .timeline-step {
            width: 2rem; height: 2rem; border-radius: 9999px; background-color: #E2E8F0;
            border: 2px solid #CBD5E1; display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: #475569; cursor: pointer; transition: all 0.2s ease-in-out;
            flex-shrink: 0; position: relative; z-index: 10;
        }
        #learning-section .timeline-step:hover { background-color: #93C5FD; border-color: #3B82F6; }
        #learning-section .timeline-step.active {
            background-color: #3B82F6; border-color: #2563EB; color: white; transform: scale(1.1);
        }
        #learning-section .problem-btn {
            padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 700; transition: all 0.2s;
        }
        #learning-section .problem-btn.active { background-color: #3B82F6; color: white; }
        #learning-section .problem-btn:not(.active) { background-color: #E2E8F0; color: #475569; }

        /* Practice Page Specific */
        #practice-section .division-grid {
            font-size: 1.8rem; line-height: 2.2rem; border: 2px solid #e5e7eb;
            padding: 1rem; border-radius: 0.5rem; background-color: #f9fafb;
        }
        #practice-section .dividend, #practice-section .quotient, #practice-section .calc-step {
             letter-spacing: 0.8em; padding-left: 0.8em;
        }
        #practice-section .quotient { height: 2.2rem; color: #3B82F6; }
        #practice-section .input-box {
            width: 5rem; height: 3rem; text-align: center; font-size: 1.5rem;
            border: 2px solid #D1D5DB; border-radius: 0.375rem;
        }
        #practice-section .input-box:focus {
            outline: none; border-color: #3B82F6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        #practice-section .input-box:disabled { background-color: #F3F4F6; color: #9CA3AF; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main Menu -->
    <div id="main-menu" class="min-h-screen flex flex-col items-center justify-center p-4 bg-gray-50">
        <div class="text-center">
            <h1 class="text-4xl sm:text-5xl font-bold text-gray-800 mb-4">ë‚˜ëˆ—ì…ˆ í•™ìŠµ ì„¼í„°</h1>
            <p class="text-lg sm:text-xl text-gray-600 mb-8">í•™ìŠµì„ ì‹œì‘í•˜ë ¤ë©´ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
        </div>
        <div id="login-form" class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-lg">
            <div class="space-y-4">
                <div>
                    <label for="student-number" class="block text-lg font-medium text-gray-700">ë²ˆí˜¸</label>
                    <select id="student-number" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg bg-white">
                        <option value="">ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                <div>
                    <label for="student-name" class="block text-lg font-medium text-gray-700">ì´ë¦„</label>
                    <input type="text" id="student-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="ì˜ˆ: í™ê¸¸ë™">
                </div>
            </div>
             <p id="login-error" class="text-red-500 text-center mt-4 h-6"></p>
            <button id="start-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-xl mt-6 transition-transform transform hover:scale-105">ì‹œì‘í•˜ê¸°</button>
        </div>

        <div id="mode-selector" class="hidden text-center mt-12">
             <p class="text-xl text-gray-600 mb-8"><span id="welcome-message" class="font-bold"></span>ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤! ë¬´ì—‡ì„ í•˜ê³  ì‹¶ë‚˜ìš”?</p>
            <div class="flex flex-col sm:flex-row gap-6">
                <button id="show-learning-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-6 px-12 rounded-xl text-2xl transition-transform transform hover:scale-105 shadow-lg">
                    ğŸ“– í•™ìŠµí•˜ê¸°
                </button>
                <button id="show-practice-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-6 px-12 rounded-xl text-2xl transition-transform transform hover:scale-105 shadow-lg">
                    âœï¸ ë¬¸ì œ í’€ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- Learning Section -->
    <div id="learning-section" class="hidden p-4 sm:p-8">
        <div class="w-full max-w-6xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <div class="flex flex-col sm:flex-row justify-between items-center border-b border-gray-200 pb-4 mb-6 gap-4">
                <h1 class="text-2xl sm:text-4xl font-bold text-gray-800 text-center sm:text-left">ë‚˜ëˆ—ì…ˆ ì›ë¦¬ ë°°ìš°ê¸°</h1>
                <button class="home-btn bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg text-lg">ğŸ  ëª¨ë“œ ì„ íƒ</button>
            </div>
            <div id="problem-selector" class="flex flex-col sm:flex-row justify-center gap-4 mb-6">
                <button id="problem1-btn" class="problem-btn">ë¬¸ì œ 1: 475 Ã· 3</button>
                <button id="problem2-btn" class="problem-btn">ë¬¸ì œ 2: 538 Ã· 4</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                <div class="flex flex-col items-center justify-center bg-gray-100 p-6 rounded-xl h-full">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">ë‚˜ëˆ—ì…ˆ ì„¸ë¡œì…ˆ ê³¼ì •</h2>
                    <div class="division-grid font-mono">
                        <div class="quotient">&nbsp;</div>
                        <div class="divisor">3</div>
                        <div class="dividend">475</div>
                        <div class="calc-step" id="l-calc-step-1">&nbsp;</div><div class="calc-step step-line" id="l-calc-step-2">&nbsp;</div>
                        <div class="calc-step" id="l-calc-step-3">&nbsp;</div><div class="calc-step" id="l-calc-step-4">&nbsp;</div>
                        <div class="calc-step step-line" id="l-calc-step-5">&nbsp;</div><div class="calc-step" id="l-calc-step-6">&nbsp;</div>
                        <div class="calc-step" id="l-calc-step-7">&nbsp;</div><div class="calc-step step-line" id="l-calc-step-8">&nbsp;</div>
                        <div class="calc-step" id="l-calc-step-9">&nbsp;</div>
                    </div>
                </div>
                <div class="bg-sky-50 p-6 rounded-xl h-full flex justify-center">
                     <div class="flex-grow">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700 flex items-center gap-3">
                            <span>ë‹¨ê³„ë³„ ì„¤ëª…</span><span class="step-counter bg-blue-100 text-blue-800 text-base font-bold px-3 py-1 rounded-full hidden"></span>
                        </h2>
                        <div class="explanation flex items-center gap-4 min-h-[200px]">
                            <div class="explanation-text flex-1 text-lg text-gray-800 space-y-2"></div>
                            <div class="explanation-image w-40 h-40 flex-shrink-0 flex items-center justify-center"></div>
                        </div>
                        <div class="multiplication-check mt-4 p-4 bg-white rounded-lg shadow-inner min-h-[60px]">
                            <h3 class="font-semibold text-lg text-sky-700">ğŸ” ê³±ì…ˆìœ¼ë¡œ í™•ì¸í•˜ê¸°</h3><p class="multiplication-text text-gray-700 mt-1"></p>
                        </div>
                     </div>
                     <div class="timeline-container"></div>
                </div>
            </div>
            <div class="mt-8 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex gap-2">
                    <button class="reset-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-lg">ë‹¤ì‹œí•˜ê¸°</button>
                    <button class="show-mistake-btn bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg text-lg">ìì£¼ í•˜ëŠ” ì‹¤ìˆ˜</button>
                </div>
                <div class="flex gap-2">
                    <button class="prev-step-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg text-lg">ì´ì „ ë‹¨ê³„</button>
                    <button class="next-step-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg">ë‹¤ìŒ ë‹¨ê³„</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Practice Section -->
    <div id="practice-section" class="hidden p-4 sm:p-8">
        <div class="w-full max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <div class="flex flex-col sm:flex-row justify-between items-center border-b border-gray-200 pb-4 mb-6 gap-4">
                <h1 class="text-2xl sm:text-4xl font-bold text-gray-800">ë‚˜ëˆ—ì…ˆ ì‹¤ë ¥ ë‹¤ì§€ê¸° <span id="problem-counter"></span></h1>
                <div class="flex gap-2">
                    <button class="export-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg text-lg" disabled>ê²°ê³¼ ì €ì¥</button>
                    <button class="home-btn bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg text-lg">ğŸ  ëª¨ë“œ ì„ íƒ</button>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="flex flex-col items-center justify-center">
                    <div class="division-grid font-mono mb-6">
                        <div class="quotient">&nbsp;</div><div class="divisor"></div><div class="dividend"></div>
                        <div class="calc-step" id="p-calc-step-1">&nbsp;</div><div class="calc-step step-line" id="p-calc-step-2">&nbsp;</div>
                        <div class="calc-step" id="p-calc-step-3">&nbsp;</div><div class="calc-step" id="p-calc-step-4">&nbsp;</div>
                        <div class="calc-step step-line" id="p-calc-step-5">&nbsp;</div><div class="calc-step" id="p-calc-step-6">&nbsp;</div>
                        <div class="calc-step" id="p-calc-step-7">&nbsp;</div><div class="calc-step step-line" id="p-calc-step-8">&nbsp;</div>
                        <div class="calc-step" id="p-calc-step-9">&nbsp;</div>
                    </div>
                    <div class="bar-display w-full h-24 bg-gray-50 rounded-lg p-2"></div>
                </div>
                <div class="bg-blue-50 p-6 rounded-xl flex flex-col justify-center">
                    <div>
                        <h2 class="instruction text-xl font-semibold text-gray-800 mb-4"></h2>
                        <div class="flex items-center justify-center gap-4">
                            <input type="number" class="input-box" disabled>
                            <button class="check-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg">ì •ë‹µ í™•ì¸</button>
                        </div>
                    </div>
                    <div class="feedback mt-4 text-center text-lg font-semibold min-h-[5rem]"></div>
                    <div id="practice-controls" class="mt-6 text-center">
                         <button class="new-set-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg w-full hidden">ìƒˆë¡œìš´ ì„¸íŠ¸ ì‹œì‘</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center text-gray-500 py-4 text-sm">&copy; 2025. í•‘í‚¤ë„¤. All rights reserved. êµìœ¡ì  ëª©ì ìœ¼ë¡œ ì›ì €ì‘ì ëª…ì‹œ í•˜ì— ê³µìœ  ë° ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</footer>

    <script>
        // ì´ ì½”ë“œëŠ” êµìœ¡ì  ëª©ì ìœ¼ë¡œ ì œì‘ë˜ì—ˆìœ¼ë©°, ì›ì €ì‘ì 'í•‘í‚¤ë„¤'ë¥¼ ëª…ì‹œí•˜ëŠ” ì¡°ê±´ í•˜ì— ììœ ë¡­ê²Œ ê³µìœ  ë° ì‚¬ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        
        // --- Main App Controller ---
        const mainMenu = document.getElementById('main-menu');
        const loginForm = document.getElementById('login-form');
        const studentNumberSelect = document.getElementById('student-number');
        const studentNameInput = document.getElementById('student-name');
        const startBtn = document.getElementById('start-btn');
        const loginErrorEl = document.getElementById('login-error');
        const modeSelector = document.getElementById('mode-selector');
        const welcomeMessageEl = document.getElementById('welcome-message');
        
        const learningSection = document.getElementById('learning-section');
        const practiceSection = document.getElementById('practice-section');
        const showLearningBtn = document.getElementById('show-learning-btn');
        const showPracticeBtn = document.getElementById('show-practice-btn');
        const homeBtns = document.querySelectorAll('.home-btn');

        let studentNumber = '';
        let studentName = '';

        function showSection(sectionId) {
            mainMenu.classList.add('hidden');
            learningSection.classList.add('hidden');
            practiceSection.classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');
        }

        startBtn.addEventListener('click', () => {
            studentNumber = studentNumberSelect.value;
            studentName = studentNameInput.value.trim();
            if (studentNumber && studentName) {
                loginForm.classList.add('hidden');
                welcomeMessageEl.textContent = `${studentNumber}ë²ˆ ${studentName}`;
                modeSelector.classList.remove('hidden');
                loginErrorEl.textContent = '';
            } else {
                loginErrorEl.textContent = 'ë²ˆí˜¸ì™€ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            }
        });

        showLearningBtn.addEventListener('click', () => {
            showSection('learning-section');
            if (!learningApp.initialized) learningApp.init();
        });
        showPracticeBtn.addEventListener('click', () => {
            showSection('practice-section');
            if (!practiceApp.initialized) practiceApp.init();
        });
        homeBtns.forEach(btn => btn.addEventListener('click', () => {
            showSection('main-menu');
            loginForm.classList.remove('hidden');
            modeSelector.classList.add('hidden');
        }));
        
        // Populate student number dropdown
        for (let i = 1; i <= 50; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `${i}ë²ˆ`;
            studentNumberSelect.appendChild(option);
        }

        // --- Common SVG Function ---
        function createBarsSVG(h, t, o, options = {}) {
            const { groupBox, impossible, highlightExchange } = options;
            let svg = `<svg viewBox="0 0 140 140" class="w-full h-full">`;
            let yOffset = 10;
            if (h > 0) {
                svg += `<g>`;
                for (let i = 0; i < h; i++) {
                    const isHighlighted = highlightExchange && highlightExchange.h && i === 0;
                    svg += `<rect x="${10 + (i % 4) * 30}" y="${yOffset + Math.floor(i / 4) * 30}" width="25" height="25" class="hundred-bar ${isHighlighted ? 'exchange-highlight' : ''}"/>`;
                }
                svg += `</g>`;
                if (groupBox && groupBox.h) { svg += `<rect x="8" y="${yOffset-2}" width="${groupBox.h.items * 30}" height="30" class="group-box" />`; }
                yOffset += Math.ceil(h / 4) * 30;
            }
            if (t > 0) {
                svg += `<g>`;
                for (let i = 0; i < t; i++) {
                    const isHighlighted = highlightExchange && highlightExchange.t && i < (highlightExchange.t.count || 0);
                    const isExchanging = highlightExchange && highlightExchange.t && highlightExchange.t.source === 'ten' && i < 2;
                    svg += `<rect x="${10 + (i % 10) * 12}" y="${yOffset + Math.floor(i / 10) * 30}" width="8" height="25" class="ten-bar ${isHighlighted || isExchanging ? 'exchange-highlight' : ''}"/>`;
                }
                svg += `</g>`;
                if (groupBox && groupBox.t) {
                     const itemsToBox = groupBox.t.items;
                     const fullRows = Math.floor(itemsToBox / 10);
                     const lastRowItems = itemsToBox % 10;
                     for (let r = 0; r < fullRows; r++) { svg += `<rect x="8" y="${yOffset + r * 30 - 2}" width="${10 * 12}" height="30" class="group-box" />`; }
                     if (lastRowItems > 0) { svg += `<rect x="8" y="${yOffset + fullRows * 30 - 2}" width="${lastRowItems * 12}" height="30" class="group-box" />`; }
                }
                yOffset += Math.ceil(t / 10) * 30;
            }
            if (o > 0) {
                 svg += `<g>`;
                for (let i = 0; i < o; i++) {
                    const isHighlighted = highlightExchange && highlightExchange.o && i < (highlightExchange.o.count || 0);
                    svg += `<rect x="${10 + (i % 10) * 12}" y="${yOffset + Math.floor(i / 10) * 15}" width="10" height="10" class="one-bar ${isHighlighted ? 'exchange-highlight' : ''}"/>`;
                }
                svg += `</g>`;
                 if (groupBox && groupBox.o) {
                     const itemsToBox = groupBox.o.items;
                     const fullRows = Math.floor(itemsToBox / 10);
                     const lastRowItems = itemsToBox % 10;
                     for (let r = 0; r < fullRows; r++) { svg += `<rect x="8" y="${yOffset + r * 15 - 2}" width="${10 * 12}" height="15" class="group-box" />`; }
                     if (lastRowItems > 0) { svg += `<rect x="8" y="${yOffset + fullRows * 15 - 2}" width="${lastRowItems * 12}" height="15" class="group-box" />`; }
                 }
                 yOffset += Math.ceil(o / 10) * 15;
            }
            if (impossible) { svg += `<g><line x1="10" y1="10" x2="130" y2="130" stroke="#EF4444" stroke-width="8" stroke-linecap="round"/><line x1="130" y1="10" x2="10" y2="130" stroke="#EF4444" stroke-width="8" stroke-linecap="round"/></g>`; }
            if (options === 'trophy') { svg = `<svg viewBox="0 0 140 140"><text x="70" y="75" font-size="60" text-anchor="middle" fill="#0284C7">ğŸ†</text></svg>`}
            return svg;
        }

        // --- Learning App ---
        const learningApp = {
            initialized: false,
            dividendEl: learningSection.querySelector('.dividend'),
            divisorEl: learningSection.querySelector('.divisor'),
            quotientEl: learningSection.querySelector('.quotient'),
            explanationTextEl: learningSection.querySelector('.explanation-text'),
            explanationImageEl: learningSection.querySelector('.explanation-image'),
            multiplicationTextEl: learningSection.querySelector('.multiplication-text'),
            nextStepBtn: learningSection.querySelector('.next-step-btn'),
            prevStepBtn: learningSection.querySelector('.prev-step-btn'),
            resetBtn: learningSection.querySelector('.reset-btn'),
            showMistakeBtn: learningSection.querySelector('.show-mistake-btn'),
            stepCounterEl: learningSection.querySelector('.step-counter'),
            timelineEl: learningSection.querySelector('.timeline-container'),
            problem1Btn: learningSection.querySelector('#problem1-btn'),
            problem2Btn: learningSection.querySelector('#problem2-btn'),
            calcSteps: Array.from({length: 9}, (_, i) => learningSection.querySelector(`#l-calc-step-${i + 1}`)),
            TOTAL_STEPS: 7,
            currentStep: 0,
            inMistakeMode: false,
            savedState: {},
            currentProblem: null,
            problems: {
                p1: { dividend: 475, divisor: 3, totalSteps: 7, steps: [ { text: `<p>'475 Ã· 3'ì„ ê³„ì‚°í•´ ë´…ì‹œë‹¤. 'ë‹¤ìŒ ë‹¨ê³„' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</p>`, img: [4, 7, 5], mul: '' }, { text: `<p>ë‚˜ëˆ—ì…ˆì€ <span class="highlight">ê°€ì¥ í° ìë¦¬</span>ë¶€í„° ì‹œì‘í•´ìš”.</p><p>ë°±ëª¨í˜• <span class="highlight">4</span>ê°œ ë¬¶ìŒì—ì„œ 3ê°œì”© ë¬¶ìœ¼ë©´ <span class="highlight-blue">1</span>ë¬¶ìŒì´ ë‚˜ì™€ìš”. ëª«ì˜ ë°±ì˜ ìë¦¬ì— <span class="highlight-blue">1</span>ì„ ì¨ìš”.</p>`, img: [4, 7, 5, { groupBox: { h: { items: 3 } } }], mul: `ëª«(<span class="highlight-blue">1</span>00) Ã— 3 = 300` }, { text: `<p>ëª« <span class="highlight-blue">1</span>ê³¼ 3ì„ ê³±í•œ <span class="highlight-green">3</span>ì„ 4 ì•„ë˜ì— ì¨ìš”.</p><p>ë°±ëª¨í˜• 4ê°œì—ì„œ 3ê°œë¥¼ ëœì–´ë‚´ë©´ <span class="highlight">1</span>ê°œê°€ ë‚¨ìŠµë‹ˆë‹¤.</p>`, img: [1, 7, 5], mul: `<span class="highlight-blue">1</span> Ã— 3 = <span class="highlight-green">3</span>` }, { text: `<p>ì‹­ì˜ ìë¦¬ 7ì„ ë‚´ë ¤ì¨ì„œ <span class="highlight">17</span>ì„ ë§Œë“¤ê³ , 3ìœ¼ë¡œ ë‚˜ëˆŒ ì¤€ë¹„ë¥¼ í•´ìš”. <span class="highlight">17</span> ì•ˆì—ëŠ” 3ì´ <span class="highlight-blue">5</span>ë²ˆ ë“¤ì–´ê°‘ë‹ˆë‹¤!</p>`, img: [0, 17, 5, { groupBox: { t: { items: 15 } } }], mul: `ëª«(<span class="highlight-blue">5</span>0) Ã— 3 = 150`, animation: { from: [1, 7, 5, { highlightExchange: { h: true } }], to: [0, 17, 5, { highlightExchange: { t: { count: 10 } } }], text1: `<p>ë‚¨ì€ ë°±ëª¨í˜• 1ê°œë¥¼ ì‹­ëª¨í˜• 10ê°œë¡œ ë°”ê¿”ì•¼ í•´ìš”. 1ì€ 3ë³´ë‹¤ ì‘ìœ¼ë‹ˆê¹Œìš”.</p>`, text2: `<p>ë°±ëª¨í˜• 1ê°œê°€ ì‹­ëª¨í˜• 10ê°œë¡œ ë°”ë€Œì—ˆì–´ìš”. ì›ë˜ ìˆë˜ 7ê°œì™€ í•©ì³ <span class="highlight">ì´ 17ê°œ</span>ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>` } }, { text: `<p>ëª« <span class="highlight-blue">5</span>ì™€ 3ì„ ê³±í•œ <span class="highlight-green">15</span>ë¥¼ 17 ì•„ë˜ì— ì“°ê³  ë¹¼ì¤˜ìš”.</p><p>ì‹­ëª¨í˜• 17ê°œì—ì„œ 15ê°œë¥¼ ëœì–´ë‚´ë©´ <span class="highlight">2</span>ê°œê°€ ë‚¨ìŠµë‹ˆë‹¤.</p>`, img: [0, 2, 5], mul: `<span class="highlight-blue">5</span> Ã— 3 = <span class="highlight-green">15</span>` }, { text: `<p>ì¼ì˜ ìë¦¬ 5ë¥¼ ë‚´ë ¤ì¨ì„œ <span class="highlight">25</span>ë¥¼ ë§Œë“¤ì–´ìš”. <span class="highlight">25</span> ì•ˆì—ëŠ” 3ì´ <span class="highlight-blue">8</span>ë²ˆ ë“¤ì–´ê°‘ë‹ˆë‹¤!</p>`, img: [0, 0, 25, { groupBox: { o: { items: 24 } } }], mul: `ëª«(<span class="highlight-blue">8</span>) Ã— 3 = 24`, animation: { from: [0, 2, 5, { highlightExchange: { t: { source: 'ten' } } }], to: [0, 0, 25, { highlightExchange: { o: { count: 20 } } }], text1: `<p>ë‚¨ì€ ì‹­ëª¨í˜• 2ê°œë¥¼ ì¼ëª¨í˜• 20ê°œë¡œ ë°”ê¿”ì•¼ í•´ìš”. 2ì€ 3ë³´ë‹¤ ì‘ìœ¼ë‹ˆê¹Œìš”.</p>`, text2: `<p>ì‹­ëª¨í˜• 2ê°œê°€ ì¼ëª¨í˜• 20ê°œë¡œ ë°”ë€Œì—ˆì–´ìš”. ì›ë˜ ìˆë˜ 5ê°œì™€ í•©ì³ <span class="highlight">ì´ 25ê°œ</span>ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>` } }, { text: `<p>ëª« <span class="highlight-blue">8</span>ê³¼ 3ì„ ê³±í•œ <span class="highlight-green">24</span>ë¥¼ 25 ì•„ë˜ì— ì“°ê³  ë¹¼ì¤˜ìš”.</p><p>ì¼ëª¨í˜• 25ê°œì—ì„œ 24ê°œë¥¼ ëœì–´ë‚´ë©´ <span class="highlight">1</span>ê°œê°€ ë‚¨ì•„ìš”. ì´ê²ƒì´ ë‚˜ë¨¸ì§€ì…ë‹ˆë‹¤.</p>`, img: [0, 0, 1], mul: `<span class="highlight-blue">8</span> Ã— 3 = <span class="highlight-green">24</span>` }, { text: `<p class="font-bold text-xl">ê³„ì‚° ì™„ë£Œ!</p><p>ëª«ì€ <span class="highlight-green">158</span>, ë‚˜ë¨¸ì§€ëŠ” <span class="highlight">1</span>ì…ë‹ˆë‹¤.</p><p>ê³±ì…ˆìœ¼ë¡œ í™•ì¸í•´ë³¼ê¹Œìš”?</p>`, img: 'trophy', mul: `(ëª« <span class="highlight-green">158</span> Ã— 3) + ë‚˜ë¨¸ì§€ <span class="highlight">1</span> = 475` } ] },
                p2: { dividend: 538, divisor: 4, totalSteps: 7, steps: [ { text: `<p>'538 Ã· 4'ë¥¼ ê³„ì‚°í•´ ë´…ì‹œë‹¤. 'ë‹¤ìŒ ë‹¨ê³„' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</p>`, img: [5, 3, 8], mul: '' }, { text: `<p>ë°±ì˜ ìë¦¬ <span class="highlight">5</span> ì•ˆì— 4ê°€ ëª‡ ë²ˆ ë“¤ì–´ê°ˆê¹Œìš”? <span class="highlight-blue">1</span>ë²ˆ ë“¤ì–´ê°‘ë‹ˆë‹¤. ëª«ì˜ ë°±ì˜ ìë¦¬ì— <span class="highlight-blue">1</span>ì„ ì”ë‹ˆë‹¤.</p>`, img: [5, 3, 8, { groupBox: { h: { items: 4 } } }], mul: `ëª«(<span class="highlight-blue">1</span>00) Ã— 4 = 400` }, { text: `<p>ëª« <span class="highlight-blue">1</span>ê³¼ 4ë¥¼ ê³±í•œ <span class="highlight-green">4</span>ë¥¼ 5 ì•„ë˜ì— ì“°ê³  ëºë‹ˆë‹¤. <span class="highlight">1</span>ì´ ë‚¨ìŠµë‹ˆë‹¤.</p>`, img: [1, 3, 8], mul: `<span class="highlight-blue">1</span> Ã— 4 = <span class="highlight-green">4</span>` }, { text: `<p>ì‹­ì˜ ìë¦¬ 3ì„ ë‚´ë ¤ì¨ì„œ <span class="highlight">13</span>ì„ ë§Œë“¤ì–´ìš”. <span class="highlight">13</span> ì•ˆì—ëŠ” 4ê°€ <span class="highlight-blue">3</span>ë²ˆ ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>`, img: [0, 13, 8, { groupBox: { t: { items: 12 } } }], mul: `ëª«(<span class="highlight-blue">3</span>0) Ã— 4 = 120`, animation: { from: [1, 3, 8, { highlightExchange: { h: true } }], to: [0, 13, 8, { highlightExchange: { t: { count: 10 } } }], text1: `<p>ë‚¨ì€ ë°±ëª¨í˜• 1ê°œë¥¼ ì‹­ëª¨í˜• 10ê°œë¡œ ë°”ê¿”ìš”.</p>`, text2: `<p>ì›ë˜ ìˆë˜ 3ê°œì™€ í•©ì³ <span class="highlight">ì´ 13ê°œ</span>ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>` } }, { text: `<p>ëª« <span class="highlight-blue">3</span>ê³¼ 4ë¥¼ ê³±í•œ <span class="highlight-green">12</span>ë¥¼ 13 ì•„ë˜ì— ì“°ê³  ëºë‹ˆë‹¤. <span class="highlight">1</span>ì´ ë‚¨ìŠµë‹ˆë‹¤.</p>`, img: [0, 1, 8], mul: `<span class="highlight-blue">3</span> Ã— 4 = <span class="highlight-green">12</span>` }, { text: `<p>ì¼ì˜ ìë¦¬ 8ì„ ë‚´ë ¤ì¨ì„œ <span class="highlight">18</span>ì„ ë§Œë“¤ì–´ìš”. <span class="highlight">18</span> ì•ˆì—ëŠ” 4ê°€ <span class="highlight-blue">4</span>ë²ˆ ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>`, img: [0, 0, 18, { groupBox: { o: { items: 16 } } }], mul: `ëª«(<span class="highlight-blue">4</span>) Ã— 4 = 16`, animation: { from: [0, 1, 8, { highlightExchange: { t: { source: 'ten' } } }], to: [0, 0, 18, { highlightExchange: { o: { count: 10 } } }], text1: `<p>ë‚¨ì€ ì‹­ëª¨í˜• 1ê°œë¥¼ ì¼ëª¨í˜• 10ê°œë¡œ ë°”ê¿”ìš”.</p>`, text2: `<p>ì›ë˜ ìˆë˜ 8ê°œì™€ í•©ì³ <span class="highlight">ì´ 18ê°œ</span>ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>` } }, { text: `<p>ëª« <span class="highlight-blue">4</span>ì™€ 4ë¥¼ ê³±í•œ <span class="highlight-green">16</span>ì„ 18 ì•„ë˜ì— ì“°ê³  ëºë‹ˆë‹¤. <span class="highlight">2</span>ê°€ ë‚¨ìŠµë‹ˆë‹¤.</p>`, img: [0, 0, 2], mul: `<span class="highlight-blue">4</span> Ã— 4 = <span class="highlight-green">16</span>` }, { text: `<p class="font-bold text-xl">ê³„ì‚° ì™„ë£Œ!</p><p>ëª«ì€ <span class="highlight-green">134</span>, ë‚˜ë¨¸ì§€ëŠ” <span class="highlight">2</span>ì…ë‹ˆë‹¤.</p><p>ê³±ì…ˆìœ¼ë¡œ í™•ì¸í•´ë³¼ê¹Œìš”?</p>`, img: 'trophy', mul: `(ëª« <span class="highlight-green">134</span> Ã— 4) + ë‚˜ë¨¸ì§€ <span class="highlight">2</span> = 538` } ] }
            },
            init() {
                if (this.initialized) return;
                this.resetBtn.addEventListener('click', () => {
                    if (this.inMistakeMode) { this.restoreState(); } 
                    else { this.loadProblem(this.currentProblem === this.problems.p1 ? 'p1' : 'p2'); }
                });
                this.nextStepBtn.addEventListener('click', () => this.nextStep());
                this.prevStepBtn.addEventListener('click', () => this.prevStep());
                this.showMistakeBtn.addEventListener('click', () => this.playMistakeAnimation());
                this.problem1Btn.addEventListener('click', () => this.loadProblem('p1'));
                this.problem2Btn.addEventListener('click', () => this.loadProblem('p2'));
                this.loadProblem('p1');
                this.initialized = true;
            },
            buildTimeline() {
                this.timelineEl.innerHTML = '';
                for (let i = 1; i <= this.currentProblem.totalSteps; i++) {
                    const stepEl = document.createElement('div');
                    stepEl.className = 'timeline-step';
                    stepEl.innerText = i;
                    stepEl.dataset.step = i;
                    stepEl.addEventListener('click', () => this.goToStep(i));
                    this.timelineEl.appendChild(stepEl);
                    if (i < this.currentProblem.totalSteps) {
                        const lineEl = document.createElement('div');
                        lineEl.className = 'timeline-line';
                        this.timelineEl.appendChild(lineEl);
                    }
                }
            },
            updateTimeline(step) {
                const steps = this.timelineEl.querySelectorAll('.timeline-step');
                steps.forEach(el => {
                    if (parseInt(el.dataset.step) === step) { el.classList.add('active'); } 
                    else { el.classList.remove('active'); }
                });
            },
            renderCalculationState(step) {
                const problem = this.currentProblem;
                const dividendStr = String(problem.dividend);
                const d = dividendStr.split('').map(Number);
                
                this.quotientEl.innerHTML = '&nbsp;';
                this.dividendEl.innerHTML = dividendStr;
                this.calcSteps.forEach(el => { el.classList.add('hidden'); el.innerHTML = '&nbsp;'; });

                if (step === 0) return;

                const q = []; let r = 0; let currentVal = 0;
                
                currentVal = d[0]; q[0] = Math.floor(currentVal / problem.divisor);
                const product1 = q[0] * problem.divisor; r = currentVal - product1;
                const val2 = r * 10 + d[1]; q[1] = Math.floor(val2 / problem.divisor);
                const product2 = q[1] * problem.divisor; r = val2 - product2;
                const val3 = r * 10 + d[2]; q[2] = Math.floor(val3 / problem.divisor);
                const product3 = q[2] * problem.divisor; const finalRemainder = val3 - product3;
                
                const fullQuotient = q.join('');

                if (step >= 1) { this.quotientEl.innerHTML = `${q[0]}`; }
                if (step >= 2) { this.calcSteps[0].innerHTML = `${product1}`; this.calcSteps[0].classList.remove('hidden'); this.calcSteps[1].classList.remove('hidden'); this.calcSteps[2].innerHTML = `${r}`; this.calcSteps[2].classList.remove('hidden'); }
                if (step >= 3) { this.quotientEl.innerHTML = `${q[0]}${q[1]}`; this.calcSteps[2].innerHTML = `${val2}`; }
                if (step >= 4) { this.calcSteps[3].innerHTML = String(product2).padStart(2, '\u00A0'); this.calcSteps[3].classList.remove('hidden'); this.calcSteps[4].classList.remove('hidden'); this.calcSteps[5].innerHTML = String(r).padStart(2, '\u00A0'); this.calcSteps[5].classList.remove('hidden'); }
                if (step >= 5) { this.quotientEl.innerHTML = `${q[0]}${q[1]}${q[2]}`; this.calcSteps[5].innerHTML = String(val3).padStart(3, '\u00A0'); }
                if (step >= 6) { this.calcSteps[6].innerHTML = String(product3).padStart(3, '\u00A0'); this.calcSteps[6].classList.remove('hidden'); this.calcSteps[7].classList.remove('hidden'); this.calcSteps[8].innerHTML = String(finalRemainder).padStart(3, '\u00A0'); this.calcSteps[8].classList.remove('hidden'); }
                
                if (step === 1) { this.dividendEl.innerHTML = `<span class="highlight">${d[0]}</span>${d.slice(1).join('')}`; this.quotientEl.innerHTML = `<span class="highlight-blue">${q[0]}</span>`; }
                if (step === 3) { this.dividendEl.innerHTML = `${d[0]}<span class="highlight">${d[1]}</span>${d.slice(2).join('')}`; this.quotientEl.innerHTML = `${q[0]}<span class="highlight-blue">${q[1]}</span>`; }
                if (step === 5) { this.dividendEl.innerHTML = `${d.slice(0, 2).join('')}<span class="highlight">${d[2]}</span>`; this.quotientEl.innerHTML = `${q[0]}${q[1]}<span class="highlight-blue">${q[2]}</span>`; }
                if (step === 7) { this.quotientEl.innerHTML = `<span class="highlight-green">${fullQuotient}</span>`; }
            },
            renderStep(step) {
                this.currentStep = step;
                this.updateTimeline(step);
                const stepData = this.currentProblem.steps[step];
                const isAnimationStep = !!stepData.animation;
                this.nextStepBtn.disabled = isAnimationStep;
                this.prevStepBtn.disabled = isAnimationStep || step === 0;
                this.showMistakeBtn.disabled = isAnimationStep;
                this.timelineEl.querySelectorAll('.timeline-step').forEach(el => el.style.pointerEvents = isAnimationStep ? 'none' : 'auto');

                if (step > 0 && step < this.currentProblem.totalSteps) { this.stepCounterEl.innerText = `${step}ë‹¨ê³„`; this.stepCounterEl.classList.remove('hidden'); } 
                else { this.stepCounterEl.classList.add('hidden'); }
                
                this.renderCalculationState(step);

                if (isAnimationStep) {
                    const anim = stepData.animation;
                    this.explanationTextEl.innerHTML = anim.text1; this.explanationImageEl.innerHTML = createBarsSVG(...anim.from);
                    setTimeout(() => { this.explanationTextEl.innerHTML = anim.text2; this.explanationImageEl.innerHTML = createBarsSVG(...anim.to); }, 1500);
                    setTimeout(() => { this.explanationTextEl.innerHTML = stepData.text; this.explanationImageEl.innerHTML = createBarsSVG(...stepData.img); this.nextStepBtn.disabled = false; this.prevStepBtn.disabled = false; this.showMistakeBtn.disabled = false; this.timelineEl.querySelectorAll('.timeline-step').forEach(el => el.style.pointerEvents = 'auto'); }, 3000);
                } else { this.explanationTextEl.innerHTML = stepData.text; this.explanationImageEl.innerHTML = createBarsSVG(...(Array.isArray(stepData.img) ? stepData.img : [0,0,0]), stepData.img); }
                
                this.multiplicationTextEl.innerHTML = stepData.mul;
                this.nextStepBtn.innerText = step === this.currentProblem.totalSteps ? 'âœï¸ ë¬¸ì œ í’€ê¸°' : 'ë‹¤ìŒ ë‹¨ê³„';
            },
            loadProblem(problemId) {
                this.currentProblem = this.problems[problemId];
                this.problem1Btn.classList.toggle('active', problemId === 'p1'); this.problem2Btn.classList.toggle('active', problemId === 'p2');
                this.divisorEl.innerText = this.currentProblem.divisor;
                this.inMistakeMode = false;
                this.buildTimeline();
                this.renderStep(0);
                this.resetBtn.innerText = 'ë‹¤ì‹œí•˜ê¸°';
                this.showMistakeBtn.disabled = false;
            },
            nextStep() {
                if (this.currentStep < this.currentProblem.totalSteps) { 
                    this.renderStep(this.currentStep + 1); 
                } else {
                    showSection('practice-section');
                    if (!practiceApp.initialized) practiceApp.init();
                }
            },
            prevStep() { if (this.currentStep > 0) { this.renderStep(this.currentStep - 1); } },
            goToStep(step) { if (!this.inMistakeMode && step >= 0 && step <= this.currentProblem.totalSteps) { this.renderStep(step); } },
            saveCurrentState() { this.savedState = { currentStep: this.currentStep }; },
            restoreState() { this.inMistakeMode = false; this.resetBtn.innerText = 'ë‹¤ì‹œí•˜ê¸°'; this.showMistakeBtn.disabled = false; this.renderStep(this.savedState.currentStep); },
            playMistakeAnimation() {
                if (!this.inMistakeMode) { this.saveCurrentState(); }
                this.inMistakeMode = true;
                this.nextStepBtn.disabled = true; this.prevStepBtn.disabled = true; this.showMistakeBtn.disabled = true; this.resetBtn.disabled = true;
                this.stepCounterEl.innerText = 'ì‹¤ìˆ˜!'; this.stepCounterEl.classList.remove('hidden'); this.updateTimeline(-1);
                this.quotientEl.innerHTML = '&nbsp;'; this.calcSteps.forEach(step => step.classList.add('hidden'));
                const firstDigit = Number(String(this.currentProblem.dividend)[0]); const divisor = this.currentProblem.divisor;
                const wrongQuotient = Math.floor(firstDigit / divisor) + 1; const wrongProduct = wrongQuotient * divisor;
                this.dividendEl.innerHTML = `<span class="highlight">${firstDigit}</span>` + String(this.currentProblem.dividend).substring(1);
                setTimeout(() => { this.quotientEl.innerHTML = `<span class="highlight-blue">${wrongQuotient}</span>&nbsp;&nbsp;`; this.explanationTextEl.innerHTML = `<p class="font-bold text-red-600">[ì‹¤ìˆ˜ ê³¼ì •] ëª«ì„ ë„ˆë¬´ í¬ê²Œ ì˜ˆìƒí–ˆì–´ìš”!</p><p>ë§Œì•½ ë°±ì˜ ìë¦¬ ëª«ì„ <span class="highlight-blue">${wrongQuotient}</span>ë¼ê³  ìƒê°í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”?</p>`; this.explanationImageEl.innerHTML = createBarsSVG(...String(this.currentProblem.dividend).split('').map(Number)); this.multiplicationTextEl.innerHTML = `ì˜ëª»ëœ ëª«(<span class="highlight-blue">${wrongQuotient}</span>00) Ã— ${divisor} = ${wrongProduct}00`; }, 500);
                setTimeout(() => { this.calcSteps[0].innerHTML = `<span class="highlight-green">${wrongProduct}</span>`; this.calcSteps[0].classList.remove('hidden'); this.explanationTextEl.innerHTML = `<p class="font-bold text-red-600">[ì‹¤ìˆ˜ ê³¼ì •] ëº„ ìˆ˜ê°€ ì—†ì–´ìš”!</p><p>ëª« <span class="highlight-blue">${wrongQuotient}</span>ê³¼ ${divisor}ë¥¼ ê³±í•˜ë‹ˆ <span class="highlight-green">${wrongProduct}</span>ë„¤ìš”. ì–´? ë°±ì˜ ìë¦¬ <span class="highlight">${firstDigit}</span>ì—ì„œ <span class="highlight-green">${wrongProduct}</span>ë¥¼ ëº„ ìˆ˜ê°€ ì—†ì–´ìš”!</p><p>ì´ê²ƒì€ ëª«ì„ ë„ˆë¬´ í¬ê²Œ ì¡ì•˜ë‹¤ëŠ” ì‹ í˜¸ì˜ˆìš”.</p>`; this.explanationImageEl.innerHTML = createBarsSVG(firstDigit, 0, 0, { impossible: true }); this.multiplicationTextEl.innerHTML = `<span class="highlight-blue">${wrongQuotient}</span> Ã— ${divisor} = <span class="highlight-green">${wrongProduct}</span>  â¡ï¸  ${firstDigit} - ${wrongProduct} = ? (ë¶ˆê°€ëŠ¥!)`; }, 2500);
                setTimeout(() => { this.explanationTextEl.innerHTML = `<p class="font-bold text-red-600">[ê²°ë¡ ] ëª«ì„ ì¤„ì—¬ì•¼ í•´ìš”!</p><p>ëº€ ê°’ì´ ë‚˜ëˆ„ëŠ” ìˆ˜ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤. ì´ëŸ´ ë• ëª«ì„ ì¤„ì—¬ì„œ ë‹¤ì‹œ ê³„ì‚°í•´ì•¼ í•´ìš”.</p><p>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ì „ ì„¤ëª…ìœ¼ë¡œ ëŒì•„ê°€ì„¸ìš”.</p>`; this.resetBtn.innerText = 'ì„¤ëª…ìœ¼ë¡œ ëŒì•„ê°€ê¸°'; this.resetBtn.disabled = false; }, 4500);
            }
        };

        // --- Practice App ---
        const practiceApp = {
            initialized: false,
            dividendEl: practiceSection.querySelector('.dividend'),
            divisorEl: practiceSection.querySelector('.divisor'),
            quotientEl: practiceSection.querySelector('.quotient'),
            barDisplayEl: practiceSection.querySelector('.bar-display'),
            instructionEl: practiceSection.querySelector('.instruction'),
            userInputEl: practiceSection.querySelector('.input-box'),
            checkBtn: practiceSection.querySelector('.check-btn'),
            feedbackEl: practiceSection.querySelector('.feedback'),
            newSetBtn: practiceSection.querySelector('.new-set-btn'),
            exportBtn: practiceSection.querySelector('.export-btn'),
            problemCounterEl: practiceSection.querySelector('#problem-counter'),
            calcSteps: Array.from({length: 9}, (_, i) => practiceSection.querySelector(`#p-calc-step-${i + 1}`)),
            problemSet: [],
            currentProblemIndex: 0,
            TOTAL_PROBLEMS_PER_SET: 5,
            currentStep: 0,
            fullPracticeLog: [],
            currentStepAttempts: [],
            init() {
                if (this.initialized) return;
                this.newSetBtn.addEventListener('click', () => this.startNewSet());
                this.checkBtn.addEventListener('click', () => this.checkAnswer());
                this.userInputEl.addEventListener('keyup', (e) => { if (e.key === 'Enter') { this.checkAnswer(); } });
                this.exportBtn.addEventListener('click', () => this.exportToCsv());
                this.startNewSet();
                this.initialized = true;
            },
            generateProblem() {
                const divisor = Math.floor(Math.random() * 8) + 2; 
                let quotient = Math.floor(Math.random() * 200) + 100;
                let dividend = divisor * quotient + Math.floor(Math.random() * divisor);
                
                while (dividend > 999) {
                    quotient = Math.floor(Math.random() * 200) + 100;
                    dividend = divisor * quotient + Math.floor(Math.random() * divisor);
                }

                const d = String(dividend).split('').map(Number); const q = String(quotient).split('').map(Number);
                const steps = []; let r = 0; let currentVal;
                
                // Hundreds
                currentVal = d[0]; steps.push({ type: 'quotient', answer: q[0], val: currentVal, instruction: `ë°±ì˜ ìë¦¬ <b class="text-blue-600">${currentVal}</b> ì•ˆì— ${divisor}ì´/ê°€ ëª‡ ë²ˆ ë“¤ì–´ê°ˆê¹Œìš”?`, feedback: `ì •ë‹µì…ë‹ˆë‹¤! ${currentVal} ì•ˆì—ëŠ” ${divisor}ì´/ê°€ ${q[0]}ë²ˆ ë“¤ì–´ê°€ìš”.` });
                let product = q[0] * divisor; r = currentVal - product;
                steps.push({ type: 'multiply', answer: product, instruction: `ëª« <b class="text-blue-600">${q[0]}</b>ê³¼ ë‚˜ëˆ„ëŠ” ìˆ˜ <b class="text-blue-600">${divisor}</b>ì„/ë¥¼ ê³±í•œ ê°’ì€?`, feedback: `ë§ì•„ìš”! ${q[0]} Ã— ${divisor} = ${product} ì…ë‹ˆë‹¤.`, remainder: r });
                
                // Tens
                currentVal = r * 10 + d[1]; steps.push({ type: 'quotient', answer: q[1], val: currentVal, instruction: `ì‹­ì˜ ìë¦¬ <b class="text-blue-600">${currentVal}</b> ì•ˆì— ${divisor}ì´/ê°€ ëª‡ ë²ˆ ë“¤ì–´ê°ˆê¹Œìš”?`, feedback: `ì •ë‹µì…ë‹ˆë‹¤! ${currentVal} ì•ˆì—ëŠ” ${divisor}ì´/ê°€ ${q[1]}ë²ˆ ë“¤ì–´ê°€ìš”.` });
                product = q[1] * divisor; r = currentVal - product;
                steps.push({ type: 'multiply', answer: product, instruction: `ëª« <b class="text-blue-600">${q[1]}</b>ê³¼ ë‚˜ëˆ„ëŠ” ìˆ˜ <b class="text-blue-600">${divisor}</b>ì„/ë¥¼ ê³±í•œ ê°’ì€?`, feedback: `ë§ì•„ìš”! ${q[1]} Ã— ${divisor} = ${product} ì…ë‹ˆë‹¤.`, remainder: r });
                
                // Ones
                currentVal = r * 10 + d[2]; steps.push({ type: 'quotient', answer: q[2], val: currentVal, instruction: `ì¼ì˜ ìë¦¬ <b class="text-blue-600">${currentVal}</b> ì•ˆì— ${divisor}ì´/ê°€ ëª‡ ë²ˆ ë“¤ì–´ê°ˆê¹Œìš”?`, feedback: `ì •ë‹µì…ë‹ˆë‹¤! ${currentVal} ì•ˆì—ëŠ” ${divisor}ì´/ê°€ ${q[2]}ë²ˆ ë“¤ì–´ê°€ìš”.` });
                product = q[2] * divisor; r = currentVal - product;
                steps.push({ type: 'multiply', answer: product, instruction: `ëª« <b class="text-blue-600">${q[2]}</b>ê³¼ ë‚˜ëˆ„ëŠ” ìˆ˜ <b class="text-blue-600">${divisor}</b>ì„/ë¥¼ ê³±í•œ ê°’ì€?`, feedback: `ë§ì•„ìš”! ${q[2]} Ã— ${divisor} = ${product} ì…ë‹ˆë‹¤.`, remainder: r });
                
                return { dividend, divisor, steps };
            },
            setupUIForStep() {
                const stepData = this.problem.steps[this.currentStep];
                if (!stepData) {
                    this.currentProblemIndex++;
                    if (this.currentProblemIndex < this.TOTAL_PROBLEMS_PER_SET) {
                        this.feedbackEl.innerHTML = `<span class="text-blue-600">ì¢‹ì•„ìš”! ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.</span>`;
                        setTimeout(() => this.loadPracticeProblem(this.currentProblemIndex), 2000);
                    } else {
                        this.instructionEl.innerHTML = 'ğŸ‰<br>ëª¨ë“  ë¬¸ì œë¥¼ ë‹¤ í’€ì—ˆì–´ìš”! ìˆ˜ê³ í–ˆìŠµë‹ˆë‹¤.';
                        this.userInputEl.disabled = true; this.checkBtn.disabled = true;
                        this.feedbackEl.innerHTML = `<span class="text-green-600">í•™ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>`;
                        this.newSetBtn.classList.remove('hidden');
                        this.exportBtn.disabled = false;
                    }
                    return;
                }
                this.instructionEl.innerHTML = stepData.instruction;
                this.userInputEl.value = ''; this.userInputEl.disabled = false; this.userInputEl.focus();
                this.checkBtn.disabled = false; this.feedbackEl.textContent = '';
                this.currentStepAttempts = [];
            },
            renderLongDivision() {
                this.quotientEl.innerHTML = '&nbsp;';
                this.calcSteps.forEach(el => { el.innerHTML = '&nbsp;'; el.classList.add('hidden'); });
                const s = this.problem.steps;
                const q = [s[0].answer, s[2].answer, s[4].answer];
                const fullQuotient = q.join('');

                // --- RENDER QUOTIENT ---
                let quotientHTML = '';
                if (this.currentStep >= 1) { quotientHTML += q[0]; }
                if (this.currentStep >= 3) { quotientHTML += q[1]; }
                if (this.currentStep >= 5) { quotientHTML += q[2]; }
                
                if (this.currentStep >= 1 && this.currentStep < 3) { quotientHTML += `<span class="text-gray-300">__</span>`; }
                else if (this.currentStep >= 3 && this.currentStep < 5) { quotientHTML += `<span class="text-gray-300">_</span>`; }
                
                if (this.currentStep >= this.problem.steps.length) {
                    this.quotientEl.innerHTML = `<span class="text-green-600">${fullQuotient}</span>`;
                } else {
                    this.quotientEl.innerHTML = quotientHTML;
                }

                // --- RENDER CALCULATION ---
                if (this.currentStep >= 2) {
                    this.calcSteps[0].innerHTML = String(s[1].answer);
                    this.calcSteps[0].classList.remove('hidden');
                    this.calcSteps[1].classList.remove('hidden'); 
                    this.calcSteps[2].innerHTML = String(s[2].val).padStart(2, '\u00A0');
                    this.calcSteps[2].classList.remove('hidden');
                }
                
                if (this.currentStep >= 4) {
                    this.calcSteps[3].innerHTML = String(s[3].answer).padStart(2, '\u00A0');
                    this.calcSteps[3].classList.remove('hidden');
                    this.calcSteps[4].classList.remove('hidden');
                    this.calcSteps[5].innerHTML = String(s[4].val).padStart(3, '\u00A0');
                    this.calcSteps[5].classList.remove('hidden');
                } 
                
                if (this.currentStep >= 6) {
                    this.calcSteps[6].innerHTML = String(s[5].answer).padStart(3, '\u00A0');
                    this.calcSteps[6].classList.remove('hidden');
                    this.calcSteps[7].classList.remove('hidden');
                    this.calcSteps[8].innerHTML = String(s[5].remainder).padStart(3, '\u00A0');
                    this.calcSteps[8].classList.remove('hidden');
                }
            },
            checkAnswer() {
                const userAnswer = parseInt(this.userInputEl.value);
                const stepData = this.problem.steps[this.currentStep];
                const correctAnswer = stepData.answer;

                if (isNaN(userAnswer)) {
                    this.feedbackEl.innerHTML = 'ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                    this.feedbackEl.className = 'mt-4 text-center text-lg font-semibold text-yellow-600';
                    return;
                }
                
                const isCorrect = userAnswer === correctAnswer;

                if (isCorrect) {
                     this.fullPracticeLog.push({
                        problemNumber: this.currentProblemIndex + 1,
                        problem: `${this.problem.dividend} Ã· ${this.problem.divisor}`,
                        question: this.instructionEl.innerText,
                        studentAnswer: userAnswer,
                        isCorrect: 'O',
                        attempts: this.currentStepAttempts.length + 1,
                        incorrectAnswers: this.currentStepAttempts.join(', ')
                    });
                    this.feedbackEl.innerHTML = stepData.feedback;
                    this.feedbackEl.className = 'mt-4 text-center text-lg font-semibold text-green-600';
                    this.userInputEl.disabled = true;
                    this.checkBtn.disabled = true;
                    
                    this.currentStep++;
                    this.renderLongDivision();
                    
                    if (stepData.type === 'multiply') {
                        setTimeout(() => {
                            this.setupUIForStep();
                        }, 1500);
                    } else { // type === 'quotient'
                        setTimeout(() => {
                            this.setupUIForStep();
                        }, 1000);
                    }
                } else {
                    this.currentStepAttempts.push(userAnswer);
                    let hint = 'ë‹¤ì‹œ ìƒê°í•´ ë³´ì„¸ìš”. ğŸ¤”';
                    if (stepData.type === 'quotient') {
                        const product = userAnswer * this.problem.divisor;
                        if (product > stepData.val) {
                            hint = `ëª«ì´ ë„ˆë¬´ ì»¤ìš”. ${userAnswer} Ã— ${this.problem.divisor} = ${product} ì´ë¯€ë¡œ, ${stepData.val} ë³´ë‹¤ ì»¤ì„œ ëº„ ìˆ˜ê°€ ì—†ì–´ìš”.`;
                        } else {
                            const remainder = stepData.val - product;
                            if (remainder >= this.problem.divisor) {
                                hint = `${userAnswer}ì€/ëŠ” ë„ˆë¬´ ì‘ì€ ëª«ì´ì—ìš”. <br> ${this.problem.divisor} Ã— ${userAnswer} = ${product} ì´ê³ , ${stepData.val} - ${product} = ${remainder} ì´ë¯€ë¡œ ë‚˜ë¨¸ì§€ê°€ ë‚˜ëˆ„ëŠ” ìˆ˜(${this.problem.divisor})ë³´ë‹¤ ì»¤ìš”.`;
                            }
                        }
                    } else if (stepData.type === 'multiply') {
                        hint = 'ê³±ì…ˆ ê²°ê³¼ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ë³´ì„¸ìš”.';
                    }
                    
                    this.feedbackEl.innerHTML = hint;
                    this.feedbackEl.className = 'mt-4 text-center text-lg font-semibold text-red-600';
                    this.userInputEl.value = '';
                    this.userInputEl.focus();
                }
            },
            startNewSet() {
                this.problemSet = [];
                this.fullPracticeLog = [];
                for (let i = 0; i < this.TOTAL_PROBLEMS_PER_SET; i++) {
                    this.problemSet.push(this.generateProblem());
                }
                this.currentProblemIndex = 0;
                this.loadPracticeProblem(0);
                this.newSetBtn.classList.add('hidden');
                this.exportBtn.disabled = true;
            },
            loadPracticeProblem(index) {
                this.problem = this.problemSet[index];
                this.currentStep = 0;
                this.problemCounterEl.textContent = `(${index + 1}/${this.TOTAL_PROBLEMS_PER_SET})`;
                this.dividendEl.textContent = this.problem.dividend;
                this.divisorEl.textContent = this.problem.divisor;
                const d = String(this.problem.dividend).split('').map(Number);
                this.barDisplayEl.innerHTML = this.createPracticeBarsSVG(d[0], d[1], d[2]);
                this.renderLongDivision();
                this.setupUIForStep();
            },
            startNewProblem() { // This is now an alias for startNewSet
                this.startNewSet();
            },
            exportToCsv() {
                if (this.fullPracticeLog.length === 0) {
                    alert('ì €ì¥í•  í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const now = new Date();
                const date = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const time = `${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}-${String(now.getSeconds()).padStart(2, '0')}`;
                const filename = `${studentNumber}_${studentName}_${date}_${time}.csv`;

                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // Add BOM for Excel
                csvContent += "ë¬¸ì œ ë²ˆí˜¸,ë¬¸ì œ,ì§ˆë¬¸,ìµœì¢… ë‹µì•ˆ,ì •ë‹µ ì—¬ë¶€,ì‹œë„ íšŸìˆ˜,ì˜¤ë‹µ ê¸°ë¡\r\n";

                this.fullPracticeLog.forEach(log => {
                    const question = `"${log.question.replace(/"/g, '""')}"`;
                    const row = [log.problemNumber, log.problem, question, log.studentAnswer, log.isCorrect, log.attempts, `"${log.incorrectAnswers}"`].join(',');
                    csvContent += row + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };
    </script>
</body>
</html>
